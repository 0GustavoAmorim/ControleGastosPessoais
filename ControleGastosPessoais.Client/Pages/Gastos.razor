@page "/gastos"
@inject GastosServices GastosService
@inject CategoriasService CategoriasServices
@inject ISnackbar SnackBar

<MudText Typo="Typo.h3" Align="Align.Center">Registrar Gastos</MudText>

<EditForm Model="@novoGasto"
          OnValidSubmit="@OnValidSubmit">
    <DataAnnotationsValidator />

    <MudGrid>
        <MudItem xs="6">
            <MudTextField Label="Descrição" Class="mt-3" HelperText="Max. 50 caracteres"
                          @bind-Value="novoGasto.Descricao" For="@(() => novoGasto.Descricao)" />
        </MudItem>

        <MudItem xs="6">
            <MudSelect @bind-Value="novoGasto.CategoriaId" Label="Categoria" Class="mt-3" Placeholder="Selecione a Categoria" AdornmentIcon="fa-solid fa-bookmark">
                <MudSelectItem Value="1">Sem Categoria</MudSelectItem>
                @foreach (var categoria in categorias.Where(c => c.Id != 1))
                {
                    <MudSelectItem Value="@categoria.Id">@categoria.Nome</MudSelectItem>
                }
            </MudSelect>
            <ValidationMessage For="@(() => novoGasto.CategoriaId)" />
        </MudItem>
        
        <MudItem xs="6">
            <MudNumericField Label="Valor" HelperText="Não pode ser 0(zero)"
                             @bind-Value="novoGasto.Valor" For="@(() => novoGasto.Valor)" />
        </MudItem>

        <MudItem xs="6">
            <MudDatePicker Label="Basic example" @bind-Date="novoGasto.Data" />

            @* <MudTextField @bind-Value="novoGasto.Data" Format="dd/MM/yyyy" Label="Data" Variant="Variant.Outlined" Margin="Margin.Dense" /> *@
        </MudItem>

        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Salvar</MudButton>
    </MudGrid>
</EditForm>

<MudText Typo="Typo.h5" Class="mt-5">Lista de Gastos</MudText>

<MudTable @ref="@_table" Items="@listaGastos" RowsPerPage="4" Hover="true" Breakpoint="Breakpoint.Sm" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Descrição</MudTh>
        <MudTh>Valor</MudTh>
        <MudTh>Categoria</MudTh>
        <MudTh>Data</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Nr">@context.Descricao</MudTd>
        <MudTd DataLabel="Sign">@context.Valor</MudTd>
        <MudTd DataLabel="Name">@context.CategoriaNome</MudTd>
        <MudTd DataLabel="Position">@context.Data</MudTd>
    </RowTemplate>
    <PagerContent>
        <MudPagination SelectedChanged="PageChanged" Count="@((_table.GetFilteredItemsCount() + _table.RowsPerPage - 1) / _table.RowsPerPage)" Class="pa-4" />
    </PagerContent>
</MudTable>


@code {
    private MudTable<GastoResponseDTO> _table;
    private List<GastoResponseDTO> listaGastos = new();
    private List<CategoriaResponseDTO> categorias = new();
    private GastoRequestDTO novoGasto = new() { Data = DateTime.Now };

    protected override async Task OnInitializedAsync()
    {
        categorias = await CategoriasServices.GetCategorias();
        listaGastos = await GastosService.GetGastos();
        StateHasChanged();
    }

    private async Task OnValidSubmit()
    {
        await SalvarGasto();
    }

    private async Task SalvarGasto()
    {
        await GastosService.AddGasto(novoGasto);
        listaGastos = await GastosService.GetGastos();
        novoGasto = new() { Data = DateTime.Now };
        SnackBar.Configuration.PositionClass = "Top-Center";
        SnackBar.Add("Gasto Cadastrado!!", Severity.Success);
    }

    private void PageChanged(int i)
    {
        _table.NavigateTo(i - 1);
    }
}
